# Makefile, Flutter stack
ROOT := $(abspath $(dir $(lastword $(MAKEFILE_LIST)))/..)

# import chart-finder environment (specific to flutter frontend)
$(shell $(ROOT)/frontend/scripts/frontend-flutter-cf-env-vars-to-make.sh)
include $(ROOT)/.local/state/cf-env-vars.mk

APP_DIR ?= $(ROOT)/src/frontend/chart-finder-flutter
FVM ?= fvm
FLUTTER ?= $(FVM) flutter
FLUTTER_VER ?= $(CF_FRONTEND_FLUTTER_VER)
DART ?= $(FVM) dart

# must have flutter version
ifeq ($(strip $(FLUTTER_VER)),)
$(error FLUTTER_VER is empty - rerun 'make setup-dev-env')
endif

FRONTEND_SCRIPTS_DIR := $(ROOT)/scripts
FRONTEND_SRC_SIG_SCRIPT := $(FRONTEND_SCRIPTS_DIR)/frontend-src-sig.sh
FRONTEND_VERSION_ARTIFACTS_SCRIPT := $(FRONTEND_SCRIPTS_DIR)/frontend-version-artifacts.sh
FRONTEND_FLUTTER_PUB_GET_STAMP := $(the_cf_env_vars_state_dir)/frontend-flutter-pub-get.stamp

.DEFAULT_GOAL := help

.PHONY: help all install deps ci build-number version-artifacts build build-android build-ios build-macos build-windows test lint typecheck clean veryclean rebuild reinstall publish start start-ios start-android start-macos android ios refresh-ios refresh-android refresh-all doctor format version flutter-check

log = @printf '\n***** %s\n' "$(1)"

define fvm_cmd
	cd "$(APP_DIR)" && $(FVM) $(1)
endef

define flutter_cmd
	cd "$(APP_DIR)" && $(FLUTTER) $(1)
endef

define flutter_run
	cd "$(APP_DIR)" && $(FLUTTER) run $(1)
endef

help:
	@printf "%s\n" \
		"Available Flutter targets:" \
		"  install           fvm flutter pub get" \
		"  deps              Ensure Flutter dependencies + version artifacts" \
		"  version-artifacts Generate source artifacts from version metadata" \
		"  build-number      Update build number when sources change" \
		"  ci                fvm flutter pub get (clean workflow placeholder)" \
		"  build             Alias for build-android (fast, host-agnostic sanity build)" \
		"  build-android     fvm flutter build apk --debug" \
		"  build-ios         fvm flutter build ios --simulator (macOS only)" \
		"  build-macos       fvm flutter build macos (macOS only)" \
		"  build-windows     fvm flutter build windows (Windows host required)" \
		"  test              fvm flutter test" \
		"  lint              fvm flutter analyze" \
		"  typecheck         Alias for lint until we add a stricter pass" \
		"  start             fvm flutter run -d chrome" \
		"  start-ios         fvm flutter run -d ios" \
		"  start-android     fvm flutter run -d android" \
		"  start-macos       fvm flutter run -d macos" \
		"  android           fvm flutter run -d android" \
		"  ios               fvm flutter run -d ios" \
		"  refresh-ios       flutter clean + build ios + run -d ios" \
		"  refresh-android   flutter clean + build apk + run -d android" \
		"  refresh-all       flutter clean + build ios/android artifacts" \
		"  doctor            fvm flutter doctor" \
		"  format            fvm flutter format lib test" \
		"  reinstall         clean + install" \
		"  clean             flutter clean" \
		"  version           run scripts/update-version.sh frontend"

all: lint typecheck test

install: $(FRONTEND_FLUTTER_PUB_GET_STAMP)

$(FRONTEND_FLUTTER_PUB_GET_STAMP): $(APP_DIR)/pubspec.yaml $(APP_DIR)/pubspec.lock
	$(call log,FRONTEND: install)
	$(call flutter_cmd,pub get)
	@mkdir -p "$(the_cf_env_vars_state_dir)"
	@touch "$@"

deps: flutter-check install version-artifacts

build-number:
	$(call log,FRONTEND: build-number)
	@cd "$(ROOT)" && "$(FRONTEND_SRC_SIG_SCRIPT)" run

version-artifacts:
	$(call log,FRONTEND: version artifacts)
	@cd "$(ROOT)" && FRONTEND_VERSION_ARTIFACTS_OPTION_STACK=flutter "$(FRONTEND_VERSION_ARTIFACTS_SCRIPT)" run

# note: purposefully a nop because scripts/frontend-flutter-cf-env-vars-to-make.sh
# note: automatically checks for fvm / flutter and reports errors
flutter-check:

ci:
	$(call log,FRONTEND: ci)
	$(call flutter_cmd,pub get)

build: build-android

build-android: deps build-number
	$(call log,FRONTEND: build android apk)
	$(call flutter_cmd,build apk --debug)

build-ios: deps build-number
	$(call log,FRONTEND: build ios simulator)
	$(call flutter_cmd,build ios --simulator --no-codesign)

build-macos: deps build-number
	$(call log,FRONTEND: build macos)
	$(call flutter_cmd,build macos)

build-windows: deps build-number
	$(call log,FRONTEND: build windows)
	$(call flutter_cmd,build windows)

test: deps
	$(call log,FRONTEND: test)
	$(call flutter_cmd,test)

lint: deps
	$(call log,FRONTEND: lint)
	$(call flutter_cmd,analyze)

typecheck: lint
	$(call log,FRONTEND: typecheck)
	@true

clean:
	$(call log,FRONTEND: clean)
	$(call flutter_cmd,clean)
	@rm -f "$(FRONTEND_FLUTTER_PUB_GET_STAMP)"

veryclean: clean
	$(call log,FRONTEND: veryclean)
	@rm -rf "$(APP_DIR)/build" "$(APP_DIR)/.dart_tool"

rebuild:
	$(call log,FRONTEND: rebuild)
	@$(MAKE) clean
	@$(MAKE) build

publish:
	$(call log,FRONTEND: publish)
	@echo "[frontend] No Flutter publish workflow defined; skipping."

reinstall:
	$(call log,FRONTEND: reinstall)
	@$(MAKE) clean
	@$(MAKE) install

start: deps
	$(call log,FRONTEND: start web)
	$(call flutter_run,-d chrome)

start-ios: deps
	$(call log,FRONTEND: start ios)
	$(call flutter_run,-d ios)

start-android: deps
	$(call log,FRONTEND: start android)
	$(call flutter_run,-d android)

start-macos: deps
	$(call log,FRONTEND: start macos)
	$(call flutter_run,-d macos)

android: deps build-number
	$(call log,FRONTEND: android run)
	$(call flutter_run,-d android)

refresh-android:
	$(call log,FRONTEND: refresh android)
	@$(MAKE) clean
	$(call flutter_cmd,build apk)
	$(call flutter_run,-d android)

ios: deps build-number
	$(call log,FRONTEND: ios run)
	$(call flutter_run,-d ios)

refresh-ios:
	$(call log,FRONTEND: refresh ios)
	@$(MAKE) clean
	$(call flutter_cmd,build ios)
	$(call flutter_run,-d ios)

refresh-all:
	$(call log,FRONTEND: refresh all)
	@$(MAKE) clean
	$(call flutter_cmd,build ios)
	$(call flutter_cmd,build apk)

doctor: deps
	$(call log,FRONTEND: doctor)
	$(call flutter_cmd,doctor)

format: deps
	$(call log,FRONTEND: format)
	$(call flutter_cmd,format lib test)

version:
	$(call log,FRONTEND: version)
	@cd "$(ROOT)" && ./scripts/update-version.sh frontend
	@cd "$(ROOT)" && FRONTEND_VERSION_ARTIFACTS_OPTION_STACK=flutter "$(FRONTEND_VERSION_ARTIFACTS_SCRIPT)" run
